<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat App</title>
<link rel="stylesheet" href="style.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div id="username-page">
  <div class="username-box">
    <h2>Enter Username</h2>
    <input type="text" id="username" placeholder="Username">
    <button id="startBtn">Start Chat</button>
  </div>
</div>

<div id="chat-page" class="hidden">
  <div class="chat-header">
    <span>Chat App</span>
    <span id="typing-indicator"></span>
    <select id="dm-select"><option value="all">All</option></select>
  </div>
  <div id="chat-box"></div>
  <div class="chat-input">
    <input type="text" id="msgInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
const socket = io();
let username = localStorage.getItem('username');

const usernamePage = document.getElementById('username-page');
const chatPage = document.getElementById('chat-page');
const startBtn = document.getElementById('startBtn');
const usernameInput = document.getElementById('username');

const chatBox = document.getElementById('chat-box');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const dmSelect = document.getElementById('dm-select');

function showChat() {
  usernamePage.classList.add('hidden');
  chatPage.classList.remove('hidden');
  loadMessages();
}

async function loadMessages() {
  const res = await fetch('/messages/' + username);
  const msgs = await res.json();
  chatBox.innerHTML = '';
  msgs.forEach(m=>{
    if(dmSelect.value==='all' || m.to===dmSelect.value){
      const div = document.createElement('div');
      div.classList.add('message');
      div.innerHTML = `<span class="from">${m.to==="all"?m.to:m.to+" â†’ " + username}</span>: ${m.text} <span class="time">${new Date(m.time).toLocaleTimeString()}</span>`;
      chatBox.appendChild(div);
    }
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

startBtn.onclick = async ()=>{
  username = usernameInput.value.trim();
  if(!username) return alert('Enter username');
  const res = await fetch('/set-username', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({username})
  });
  const data = await res.json();
  if(data.success){
    localStorage.setItem('username', username);
    showChat();
  }
};

sendBtn.onclick = async ()=>{
  const text = msgInput.value.trim();
  const to = dmSelect.value;
  if(!text) return;
  await fetch('/messages/'+username,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({to,text})
  });
  socket.emit('dm',{from:username,to,text});
  msgInput.value='';
  loadMessages();
};

socket.on('dm', m=>{
  if(m.to==='all' || m.to===username || m.from===username) loadMessages();
});

window.onload = ()=>{
  if(username) showChat();
};
</script>
</body>
</html>
